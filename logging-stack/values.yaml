# EFK Stack Values - Cost-Optimized for Single Node t3.medium EKS Cluster
# This umbrella chart deploys Elasticsearch, Fluentd, and Kibana for centralized logging

global:
  namespace: logging

# ===========================
# Elasticsearch Configuration
# ===========================
elasticsearch:
  enabled: true

  # Single node deployment
  replicas: 1
  minimumMasterNodes: 1

  # Reduced resource limits for cost optimization
  resources:
    requests:
      cpu: "200m"
      memory: "512Mi"
    limits:
      cpu: "500m"
      memory: "1Gi"

  # JVM heap settings (should be 50% of memory limit)
  esJavaOpts: "-Xmx512m -Xms512m"

  # Persistence configuration
  persistence:
    enabled: true

  volumeClaimTemplate:
    resources:
      requests:
        storage: 5Gi

  # Single-node cluster health check (yellow is acceptable for 1 node)
  clusterHealthCheckParams: "wait_for_status=yellow&timeout=1s"

  # Service configuration
  service:
    type: ClusterIP
    ports:
      - name: http
        port: 9200
        protocol: TCP
      - name: transport
        port: 9300
        protocol: TCP

# ===========================
# Kibana Configuration
# ===========================
kibana:
  enabled: true

  replicas: 1

  # Reduced resource limits
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
    limits:
      cpu: "250m"
      memory: "512Mi"

  # LoadBalancer service for external access
  service:
    type: LoadBalancer
    port: 5601

  # Elasticsearch connection
  elasticsearchHosts: "http://logging-stack-elasticsearch-master:9200"

  # Environment variables for Elasticsearch authentication
  extraEnvs:
    - name: ELASTICSEARCH_USERNAME
      value: "elastic"
    - name: ELASTICSEARCH_PASSWORD
      valueFrom:
        secretKeyRef:
          name: logging-stack-elasticsearch-master-credentials
          key: password

  # Health checks
  readinessProbe:
    initialDelaySeconds: 60
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 6

  livenessProbe:
    initialDelaySeconds: 90
    periodSeconds: 20
    timeoutSeconds: 5
    failureThreshold: 6

# ===========================
# Fluentd Configuration
# ===========================
fluentd:
  enabled: true

  # DaemonSet ensures one pod per node for log collection
  kind: "DaemonSet"

  # Reduced resource limits
  resources:
    limits:
      cpu: 200m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 256Mi

  # Service account
  serviceAccount:
    create: true
    name: fluentd

  # RBAC for reading pod logs
  rbac:
    create: true

  # Mount host log directories
  volumeMounts:
    - name: varlog
      mountPath: /var/log
      readOnly: true
    - name: varlibdockercontainers
      mountPath: /var/lib/docker/containers
      readOnly: true

  volumes:
    - name: varlog
      hostPath:
        path: /var/log
    - name: varlibdockercontainers
      hostPath:
        path: /var/lib/docker/containers

  # Elasticsearch output configuration
  env:
    - name: FLUENT_ELASTICSEARCH_HOST
      value: "logging-stack-elasticsearch-master.logging.svc.cluster.local"
    - name: FLUENT_ELASTICSEARCH_PORT
      value: "9200"
    - name: FLUENT_ELASTICSEARCH_SCHEME
      value: "http"
    - name: FLUENT_ELASTICSEARCH_USER
      value: "elastic"
    - name: FLUENT_ELASTICSEARCH_PASSWORD
      valueFrom:
        secretKeyRef:
          name: logging-stack-elasticsearch-master-credentials
          key: password
    - name: FLUENT_ELASTICSEARCH_LOGSTASH_PREFIX
      value: "kubernetes"
    - name: FLUENT_ELASTICSEARCH_LOGSTASH_FORMAT
      value: "true"

  # Image - using official Fluentd Kubernetes DaemonSet image
  image:
    repository: "fluent/fluentd-kubernetes-daemonset"
    tag: "v1-debian-elasticsearch"
    pullPolicy: IfNotPresent

  # Tolerations to run on all nodes including master
  tolerations:
    - key: node-role.kubernetes.io/master
      effect: NoSchedule
    - key: node-role.kubernetes.io/control-plane
      effect: NoSchedule
